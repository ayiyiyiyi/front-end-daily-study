<!--
Created: Fri Jul 10 2020 19:01:25 GMT+0800 (China Standard Time)
Modified: Fri Jul 10 2020 19:01:25 GMT+0800 (China Standard Time)
-->
<!-- tag: vue, js, node -->

# vue SSR 

> 相关链接🔗：[vue-ssr服务端渲染透析](https://juejin.im/post/5ec4a1f6e51d457848684749#heading-12), [原创：2020开年之作-高质量 SSR 解析（无任何配置代码，无基础性问题分析）](https://juejin.im/post/5ec7d5cde51d45787c2d8cc5)


## 构建基于 vue-cli3 的SSR应用程序

### 第一步：创建项目

安装全局脚手架 `yarn add @vue/cli`, 

创建项目 `vue create vue-ssr-demo`, 

安装相关依赖, 如 vue-router, vuex 等

### 第二步: 对项目进行 SSR 改造

1. 安装 vue-server-renderer `yarn add vue-server-renderer`, 安装 koa 及相关中间件 `yarn add koa`

2. 在根目录下新建 server.js 文件作为服务端入口文件.
``` JS
const fs = require('fs');
const Koa = require('koa');
const path = require('path');
const koaStatic = require('koa-static');
const Router = require('koa-router');
const koaMount = require('koa-mount')
const send = require('koa-send');

const app = new Koa();
const route = new Router();

const pathResolve = pathName => path.resolve(__dirname, pathName);

const { createBundleRenderer } = require("vue-server-renderer");
const bundle = require("./dist/vue-ssr-server-bundle.json");
const clientManifest = require("./dist/vue-ssr-client-manifest.json");

const template = fs.readFileSync(path.resolve(__dirname, './src/index.template.html'), "utf-8")
// 详细 API 见: https://ssr.vuejs.org/zh/api/
// https://ssr.vuejs.org/zh/guide/bundle-renderer.html#%E4%BD%BF%E7%94%A8%E5%9F%BA%E6%9C%AC-ssr-%E7%9A%84%E9%97%AE%E9%A2%98
// createBundleRenderer 使用 server bundle 和（可选的）选项创建一个 BundleRenderer 实例。
const renderer = createBundleRenderer(bundle, {
    runInNewContext: false, // 推荐
    template, // （可选）页面模板
    clientManifest // （可选）客户端构建 manifest
})

function renderToString(context) {
    return new Promise((resolve, reject) => {
        renderer.renderToString(context, (err, html) => {
           err ? reject(err) : resolve(html)
        })
    })
}

const requestHandler = async (ctx) => {
    const context = {
        title: "ssr test",
        url: ctx.url
    };
    console.log('url:', ctx.url)
    if (ctx.url.includes('.')) {
        return await send(ctx, ctx.url, {root: pathResolve('./dist')})
    }
    const html = await renderToString(context);
    ctx.body = html;
}

// koa-router 匹配任意路由
route.get('/(.*)', requestHandler);

// 加载路由中间件
app.use(route.routes()).use(route.allowedMethods())

// 配置服务器静态资源目录
app.use(koaMount('/dist', koaStatic(pathResolve('./dist'))));

const port = 3001
app.listen(port, () => {
    console.log(`server started at localhost:${port}`);
})
```

3. 在 src 下创建 index.template.html
    这是因为, 当渲染 vue 应用程序时, render 从应用程序中生成的只是 html 片段. 所以我们需要一个页面模版来包裹这些 html 片段.

4. 在 src 下创建  entry-server.js 仅运行于服务器

5. 在 src 下创建  entry-client.js 仅运行于浏览器
    客户端 entry 只需 调用 createApp 创建根 VUE 实例，并且将其挂载到 DOM 中

6. 改造 src 下的 app.js/main.js 为通用入口
    app.js 是程序的通用入口, 在 SPA 里, 我们在这里创建 VUE 实例并挂载到根 DOM 上, 但在 SSR 中, 这一步要在 entry-client.js 中实现, 而 app.js 仅简单但 export 一个 createApp 函数. 它通过工厂模式, 为每一个请求都创建一个根 VUE 实例. 目的是每个请求的状态独立不被污染, 否则用户 A 请求改变数据状态, 用户 B 请求返回的实例中数据也会改变.
7. 在 src 下 添加 router.js, store.js 
    同 createApp 函数一样, 我们也需要对 每个请求创建新的 Router, Store 实例.
